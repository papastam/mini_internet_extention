{% set logged_in=1 %}
{% extends "admin/admin_base.html" %}

{% block head %}
{{ super() }}

<script>
let updateIntervalId = -1; // -1 means not running
latest_stats=false;

function addData(chart, label, data) {
    chart.data.labels.push(label);
    chart.data.datasets.forEach((dataset) => {
        dataset.data.push(data[dataset.label]);
    });    
    chart.update();
}

function fillData(chart, data){
    clearData(chart);
    for (var i = 0; i < data.length; i++) {
        time = data[i].time;
        delete data[i].time;
        addData(chart, time, data[i]);
    }
}

function clearData(chart){
    chart.data.labels = [];
    chart.data.datasets.forEach((dataset) => {
        dataset.data = [];
    });
    chart.update();
}

function stopCheckingForStats() {
    clearInterval(updateIntervalId);
    updateIntervalId = -1
    return 1;
}

function startCheckingForStats(){
    // Call get_updates every 1 minute
    if (updateIntervalId != -1){
        console.log("Already running")
        return -1;
    }
    return updateIntervalId = setInterval(get_stats(-1,-1), 60000);
}

function get_stats(start, end){
    var xhr = new XMLHttpRequest();
    xhr.onload = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
            console.log("DEBUG: got response: " + xhr.responseText);
            json_resp = JSON.parse(xhr.responseText);
            
            if(json_resp.length);

            input_json = [];
            for(var i = 0; i < json_resp.length; i++){
                input_json[i] = {};
                input_json[i]["time"] = json_resp[i]["time"];
                input_json[i]["CPU"] = json_resp[i]["cpu"];
                input_json[i]["Memory"] = json_resp[i]["memory"];
                input_json[i]["Disk"] = json_resp[i]["disk"];
            }

            fillData(server_res_chart, input_json);

            return json_resp;
            
        } else {
            console.log('Request failed. Returned status of ' + xhr.status);
            return -1;
        }
    };

    //TODO: Implement a "pull only latest" strategy on updates
    if(start==-1 && end==-1){
        start = 0;
    }

    xhr.open('GET', '?stats=true&start=' + start + '&end=' + end, true);
    xhr.setRequestHeader('Content-type','application/json');
    xhr.send();
}

$(document).ready(function() {
    
    $("#refreshSwitch").change(function() {
        console.log("refreshSwitch changed")
        if ((this.checked==true) && (latest_stats==true)){
            startCheckingForStats();
        } else {
            stopCheckingForStats();
        }
    });

    $("#pull_btn").click(function(){
        latest_stats=false;
        stopCheckingForStats();
        console.log("DEBUG: Pulling stats")
        
        start = $("#stats_start").val();
        end = $("#stats_end").val();
        if ($("#refreshSwitch").prop("checked")){
            end = 0;
            latest_stats = true;
            startCheckingForStats();
        }

        get_stats(start, end);

    });
    
});


</script>

<style>
    .maincontainer {
        padding: 2px 50px;
    }

    .chartbox {
        /*width: 400px;
        height: auto;*/
        box-shadow: 0 4px 8px 0 rgb(0 0 0 / 20%), 0 6px 20px 0 rgb(0 0 0 / 19%);
        margin: 10px;
        padding: 5px;
    }

    .controll_bar {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
        align-items: flex-start;
        align-content: flex-start;
        padding: 5px 20px;
        margin: 2px;
        border: #1c1c21;
        border-style: solid;
        border-width: 2px;
        border-radius: 5px;
        box-shadow: 0 4px 6px 2px rgb(0 0 0 / 20%);
    }

    .refresh_stats {
        border-bottom: 1px;
        border-style: solid;
    }

    .date_selectionst{    
        border-bottom: 1px;
        border-style: solid;
    }

    .date_selctionend{
        border-bottom: 1px;
        border-style: solid;
    }

</style>

{% endblock %}

{% block body %}

<div class="controll_bar">
    <div class="date_selectionst">
        <label for="stats_start">Start Date/Time: </label>
        <input class="datepicker" id="stats_start" name="start_date" type="datetime-local">
    </div>
    <div class="date_selctionend">
        <label for="stats_end">End Date/Time: </label>
        <input class="datepicker" id="stats_end" name="end_date" type="datetime-local">
    </div>
    <div>
        <button id="pull_btn" type="button" class="btn btn-secondary" style="background-color: #6c757d;">Pull statistics</button>
    </div>
    <div class="refresh_stats custom-switch">
        <input type="checkbox" class="custom-control-input" id="refreshSwitch">
        <label class="custom-control-label" for="refreshSwitch">Pull latest statistics</label>
    </div>
</div>

<div class="maincontainer">
    <div class="chartbox">

    {% set datasets={"CPU": "cpu", "Memory": "memory", "Disk": "disk"} %}
    {% set label="Server Resources" %}
    {% set name="server_res" %}
    {% include "admin/resource_chart.html" %}
    </div>
</div>


{% endblock %}
